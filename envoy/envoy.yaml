# ============================================================================
# ENVOY GATEWAY — HTTPS ONLY (443) + Flight TCP
# ============================================================================

admin:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901

static_resources:

  listeners:

  # --------------------------------------------------------------------------
  # HTTPS LISTENER (PORT 443) — ALL HTTP TRAFFIC
  # --------------------------------------------------------------------------
  - name: https_listener
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 443

    filter_chains:
    - transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
          common_tls_context:
            tls_certificates:
              - certificate_chain:
                  filename: /etc/envoy/certs/fullchain.pem
                private_key:
                  filename: /etc/envoy/certs/privkey.pem
            alpn_protocols:
              - h2
              - http/1.1

      filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_https
          codec_type: AUTO

          upgrade_configs:
            - upgrade_type: websocket

          access_log:
            - name: envoy.access_loggers.stdout
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog

          route_config:
            name: local_routes
            virtual_hosts:

            # ================================================================
            # DAZZLEDUCK UI
            # ================================================================
            - name: dazzleduck_service
              domains:
                - "dazzleduck-ui.com"
                - "dazzleduck-ui.com:*"
                - "www.dazzleduck-ui.com"
                - "www.dazzleduck-ui.com:*"
              routes:
                - match:
                    prefix: "/"
                    headers:
                      - name: upgrade
                        present_match: true
                  route:
                    cluster: dazzleduck_cluster
                    timeout: 0s
                - match:
                    prefix: "/"
                  route:
                    cluster: dazzleduck_cluster
                    timeout: 300s
                    host_rewrite_literal: "localhost"

            # ================================================================
            # FRONTEND
            # ================================================================
            - name: frontend_service
              domains:
                - "frontend.one211.com"
                - "frontend.one211.com:*"
                - "www.one211.com"
                - "www.one211.com:*"
              routes:
                - match:
                    prefix: "/"
                    headers:
                      - name: upgrade
                        present_match: true
                  route:
                    cluster: frontend_cluster
                    timeout: 0s
                - match:
                    prefix: "/api/"
                  route:
                    cluster: backend_cluster
                    timeout: 300s
                - match:
                    prefix: "/"
                  route:
                    cluster: frontend_cluster
                    timeout: 300s
                    host_rewrite_literal: "localhost"

            # ================================================================
            # BACKEND DIRECT
            # ================================================================
            - name: backend_service
              domains:
                - "backend.one211.com"
                - "backend.one211.com:*"
              routes:
                - match:
                    prefix: "/"
                  route:
                    cluster: backend_cluster
                    timeout: 300s

            # ================================================================
            # SQL CONTROLLER 1
            # ================================================================
            - name: controller_service
              domains:
                - "controller.one211.com"
                - "controller.one211.com:*"
              routes:
                - match:
                    prefix: "/"
                    headers:
                      - name: ":method"
                        exact_match: "OPTIONS"
                  direct_response:
                    status: 204
                  response_headers_to_add:
                    - header:
                        key: Access-Control-Allow-Origin
                        value: "*"
                    - header:
                        key: Access-Control-Allow-Methods
                        value: "GET, POST, PUT, DELETE, OPTIONS, PATCH"
                    - header:
                        key: Access-Control-Allow-Headers
                        value: "Authorization, Content-Type"
                - match:
                    prefix: "/"
                  route:
                    cluster: controller1_http_cluster
                    timeout: 300s
                  response_headers_to_add:
                    - header:
                        key: Access-Control-Allow-Origin
                        value: "https://dazzleduck-ui.com"
                      append_action: OVERWRITE_IF_EXISTS_OR_ADD
                    - header:
                        key: Access-Control-Allow-Methods
                        value: "GET, POST, PUT, DELETE, OPTIONS, PATCH"
                      append_action: OVERWRITE_IF_EXISTS_OR_ADD
                    - header:
                        key: Access-Control-Allow-Headers
                        value: "Authorization, Content-Type"
                      append_action: OVERWRITE_IF_EXISTS_OR_ADD

            # ================================================================
            # SQL CONTROLLER 2
            # ================================================================
            - name: controller2_service
              domains:
                - "controller2.one211.com"
                - "controller2.one211.com:*"
              routes:
                - match:
                    prefix: "/"
                    headers:
                      - name: ":method"
                        exact_match: "OPTIONS"
                  direct_response:
                    status: 204
                  response_headers_to_add:
                    - header:
                        key: Access-Control-Allow-Origin
                        value: "*"
                    - header:
                        key: Access-Control-Allow-Methods
                        value: "GET, POST, PUT, DELETE, OPTIONS, PATCH"
                    - header:
                        key: Access-Control-Allow-Headers
                        value: "Authorization, Content-Type"
                - match:
                    prefix: "/"
                  route:
                    cluster: controller2_http_cluster
                    timeout: 300s
                  response_headers_to_add:
                    - header:
                        key: Access-Control-Allow-Origin
                        value: "https://dazzleduck-ui.com"
                      append_action: OVERWRITE_IF_EXISTS_OR_ADD
                    - header:
                        key: Access-Control-Allow-Methods
                        value: "GET, POST, PUT, DELETE, OPTIONS, PATCH"
                      append_action: OVERWRITE_IF_EXISTS_OR_ADD
                    - header:
                        key: Access-Control-Allow-Headers
                        value: "Authorization, Content-Type"
                      append_action: OVERWRITE_IF_EXISTS_OR_ADD

          http_filters:
            - name: envoy.filters.http.router
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  # --------------------------------------------------------------------------
  # FLIGHT TCP PROXY 1 → sql-controller
  # --------------------------------------------------------------------------
  - name: flight_listener_1
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 59307
    filter_chains:
      - filters:
          - name: envoy.filters.network.tcp_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
              stat_prefix: flight_tcp_1
              cluster: controller1_flight_cluster

  # --------------------------------------------------------------------------
  # FLIGHT TCP PROXY 2 → sql-controller2
  # --------------------------------------------------------------------------
  - name: flight_listener_2
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 59301
    filter_chains:
      - filters:
          - name: envoy.filters.network.tcp_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
              stat_prefix: flight_tcp_2
              cluster: controller2_flight_cluster

  # ==========================================================================
  # CLUSTERS
  # ==========================================================================

  clusters:

  - name: dazzleduck_cluster
    connect_timeout: 5s
    type: logical_dns
    lb_policy: round_robin
    load_assignment:
      cluster_name: dazzleduck_cluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: dazzleduck-ui
                    port_value: 5174

  - name: frontend_cluster
    connect_timeout: 5s
    type: logical_dns
    lb_policy: round_robin
    load_assignment:
      cluster_name: frontend_cluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: frontend
                    port_value: 5173

  - name: backend_cluster
    connect_timeout: 5s
    type: logical_dns
    lb_policy: round_robin
    load_assignment:
      cluster_name: backend_cluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: backend
                    port_value: 8080

  - name: controller1_http_cluster
    connect_timeout: 5s
    type: logical_dns
    lb_policy: round_robin
    load_assignment:
      cluster_name: controller1_http_cluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: sql-controller
                    port_value: 9006

  - name: controller2_http_cluster
    connect_timeout: 5s
    type: logical_dns
    lb_policy: round_robin
    load_assignment:
      cluster_name: controller2_http_cluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: sql-controller2
                    port_value: 9007

  - name: controller1_flight_cluster
    connect_timeout: 5s
    type: logical_dns
    lb_policy: round_robin
    load_assignment:
      cluster_name: controller1_flight_cluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: sql-controller
                    port_value: 59307

  - name: controller2_flight_cluster
    connect_timeout: 5s
    type: logical_dns
    lb_policy: round_robin
    load_assignment:
      cluster_name: controller2_flight_cluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: sql-controller2
                    port_value: 59301
